<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="divport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <meta name="format-detection" content="telephone=no"/>
    <link rel="stylesheet" href="invalid.css">
    <title></title>
</head>
    <div class='fail'>
        <div class='fail__bgimg'>
            <img class='img'  src='https://hb3-shopguide.oss-cn-zhangjiakou.aliyuncs.com/fail.png' alt="二维码失效图片" />
        </div>
        <div class="fail__text">您好，二维码已失效哦~</div>
    </div>
<body>
<script type="text/javascript" src="./js/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="./js/common.js"></script>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<script>
    $(document).ready(function () {
        var success = getPar('success');
        var msg = getPar('msg');
        var data = getPar('data');
        if (success) {
            getCustomerInfo(data)
        } else {
            // 跳转错误页
            $(".fail").show();
            $('.fail__text').html("授权失败");
        }
    })
    window.onload = function () {

    }

    function getCustomerInfo(encryptNascentId) {
        var recruitInfo = JSON.parse(localStorage.getItem('recruitInfo'));
        this.ajax(backstageURL + '/getCustomerInfo', {
            guideId: recruitInfo.guideId,
            shopId: recruitInfo.shopId,
            groupId: recruitInfo.groupId,
            source: recruitInfo.source,
            encryptNascentId: encryptNascentId
        }).then(function (result) {
            if (result.success) {
                // 根据数据状态跳转不同页面
                if (result.result.newMember) {
                    // 调用微信官方开卡界面
                    // 初始化微信开卡JS-SDK
                    initWXConfig(function (cardId) {
                        // 跳转开卡
                        addCard(cardId,result.result.memberCard,recruitInfo.shopId,recruitInfo.groupId,result.result.outerStr)
                    })

                } else {
                    console.log(JSON.stringify(result.result))
                    localStorage.setItem('showData', JSON.stringify(result.result))
                    //非新用户-跳转已经有导购界面
                    if (recruitInfo.guideId == result.result.sgGuideId) {
                        //同一导购
                        window.location.replace("sameGuide.html")
                    } else {
                        //不同导购-判断是否允许自主更换导购
                        if(result.result.changeSgTwo){
                            window.location.replace("exchangeGuide.html")
                        }else{
                            //不允许自主更换
                            window.location.replace("memberCard.html")
                        }
                    }
                }

            } else {
                // 跳转错误页
                $(".fail").show();
                $('.fail__text').html(result.msg);
            }
        })
    }

    /**
     * 初始化微信JS-SDK参数
     */
    function initWXConfig(back) {
        var recruitInfo = JSON.parse(localStorage.getItem('recruitInfo'));
        var address = location.href.split('#')[0]
        this.ajax(backstageURL + '/getInitWXConfigParam', {url: address,shopId:recruitInfo.shopId,groupId:recruitInfo.groupId}).then(function (data) {
            wx.config(data.result.config);
            if (back) {
                back(data.result.cardId)
            }
        })
    }

    /**
     * 跳转会员领卡
     */
    function addCard(cardId, memberCard,shopId,groupId,outerStr) {
        var newCardId = cardId
        this.ajax(backstageURL + '/getAddCardExtParam', {code: memberCard,shopId:shopId,groupId:groupId,outerStr:outerStr}).then(function (data) {
            wx.ready(function () {
                wx.addCard({
                    cardList: [{
                        cardId: cardId,
                        cardExt: JSON.stringify(data.result)
                    }],
                    success: function (res) {
                        var cardList = res.cardList; // 添加的卡券列表信息
                        var guideData = JSON.parse(localStorage.getItem('showData'));
                        alert(localStorage.getItem('showData'));
                        // 跳转开卡成功页面
                        var recruitInfo = JSON.parse(localStorage.getItem('recruitInfo'));
                        if(guideData.pointAdd || guideData.pointAttention){
                            // 根据不同来源，开卡成功后根据来源跳转不同页面（1关注公众号，2微信加好友）
                            if(recruitInfo.source == 1){
                                window.location.replace("addFriend.html?guideQrCode="+guideData.guideQrCode+"&guideName="+guideData.guideName+"&guideImg="+guideData.guideImg)
                            }else{
                                //
                                window.location.replace("successfulCardOpening.html");
                            }
                        }else{
                            // 跳转不关注公众号，不加好友成功页面
                            window.location.replace("successNo.html");
                        }
                    },
                    fail: function (res) {
                        // 跳转错误页
                        $(".fail").show();
                        $('.fail__text').html("领卡失败");
                    }
                });
            })
        })
    }

    function ajax(url, data, params) {
        data = JSON.stringify(data)
        return new Promise(function (resolve, reject) {
            $.ajax({
                url: url,
                type: params && params.type || 'post',
                dataType: params && params.dataType || 'JSON',
                data: data,
                method: "post",
                contentType: "application/json;charset=UTF-8",
                success: function (res) {
                    resolve(res)
                },
                error: function (res) {
                    // 跳转错误页
                    $(".fail").show();
                    $('.fail__text').html(res.msg);
                }
            });
        });
    }
</script>
</body>
</html>
