<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="divport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <meta name="format-detection" content="telephone=no"/>
    <title></title>
</head>
<body>
<script type="text/javascript" src="./js/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="./js/common.js"></script>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<script>
    $(document).ready(function () {
        var success = getPar('success');
        var msg = getPar('msg');
        var data = getPar('data');
        if (success) {
            getCustomerInfo(data)
        } else {
            // 跳转错误页
            alert(msg)
        }
    })
    window.onload = function () {

    }

    function getCustomerInfo(encryptNascentId) {
        var recruitInfo = JSON.parse(localStorage.getItem('recruitInfo'));
        this.ajax(backstageURL + '/getCustomerInfo', {
            guideId: recruitInfo.guideId,
            shopId: recruitInfo.shopId,
            brandId: recruitInfo.brandId,
            encryptNascentId: encryptNascentId
        }).then(function (result) {
            if (result.success) {
                // 根据数据状态跳转不同页面
                alert("newMember:"+result.result.newMember)
                if (true) {
                    // 调用微信官方开卡界面
                    // 初始化微信开卡JS-SDK
                    initWXConfig(function (cardId) {
                        // 跳转开卡
                        addCard(cardId,result.result.memberCard)
                    })

                } else {
                    console.log(JSON.stringify(result.result))
                    var bean = {
                        guideImg: result.result.image,
                        guideName: result.result.sgGuideName,
                        guideQrCode: result.result.cardUrl,
                        memberCard: result.result.memberCard,
                        shopName: result.result.shopName,
                        brandName: result.result.brandName,
                        memberGrade: result.result.memberGrade,
                    }
                    localStorage.setItem('showData', JSON.stringify(bean))
                    console.log("check:" + JSON.stringify("showData").toString())
                    //非新用户-跳转已经有导购界面
                    if (recruitInfo.guideId == result.result.sgGuideId) {
                        //同一导购
                        window.location.replace("sameGuide.html")
                    } else {
                        //不同导购
                        window.location.replace("memberCard.html")
                    }
                }

            } else {
                // 跳转错误页
                alert(result.msg)
            }
        })
    }

    /**
     * 初始化微信JS-SDK参数
     */
    function initWXConfig(back) {
        var address = location.href.split('#')[0]
        this.ajax(backstageURL + '/getInitWXConfigParam', {url: address}).then(function (data) {
            wx.config(data.result.config);
            if (back) {
                back(data.result.cardId)
            }
        })
    }

    /**
     * 跳转会员领卡
     */
    function addCard(cardId, memberCard) {
        var newCardId = cardId
        this.ajax(backstageURL + '/getAddCardExtParam', {code: memberCard}).then(function (data) {
            wx.ready(function () {
                wx.addCard({
                    cardList: [{
                        cardId: cardId,
                        cardExt: JSON.stringify(data.result)
                    }],
                    success: function (res) {
                        var cardList = res.cardList; // 添加的卡券列表信息
                        var guideData = JSON.parse(localStorage.getItem('showData'));
                        // 跳转开卡成功页面
                        window.location.replace("addFriend.html?guideQrCode="+guideData.guideQrCode+"&guideName="+guideData.guideName+"&guideImg="+guideData.guideImg)
                    },
                    fail: function (res) {
                    }
                });
            })
        })
    }

    function ajax(url, data, params) {
        data = JSON.stringify(data)
        return new Promise(function (resolve, reject) {
            $.ajax({
                url: url,
                type: params && params.type || 'post',
                dataType: params && params.dataType || 'JSON',
                data: data,
                method: "post",
                contentType: "application/json;charset=UTF-8",
                success: function (res) {
                    resolve(res)
                },
                error: function (res) {
                    // 跳转错误页
                    alert(res.m)
                }
            });
        });
    }
</script>
</body>
</html>
