<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="divport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <meta name="format-detection" content="telephone=no"/>
    <title></title>
</head>
<body>
<script type="text/javascript" src="./js/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="./js/common.js"></script>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<script>
    window.onload = function () {
        var success = getPar('success');
        var msg = getPar('msg');
        var data = getPar('data');
        if (success) {
            getCustomerInfo(data)
        } else {
            // 跳转错误页
            alert(msg)
        }
    }

    function getCustomerInfo(encryptNascentId) {
        var recruitInfo = JSON.parse(localStorage.getItem('recruitInfo'));
        this.ajax(backstageURL + '/getCustomerInfo', {
            guideId: recruitInfo.guideId,
            shopId: recruitInfo.shopId,
            brandId: recruitInfo.brandId,
            encryptNascentId: encryptNascentId
        }).then(function (result) {
            if (result.success) {
                // 根据数据状态跳转不同页面
                alert(JSON.stringify(result.result))
                if (result.result.newMember) {
                    // 调用微信官方开卡界面
                    // 初始化微信开卡JS-SDK
                    initWXConfig()
                    // 跳转开卡
                    addCard(result.result.memberCard)
                } else {
                    var bean = {
                        guideImg: result.result.image,
                        guideName: result.result.sgGuideName,
                        guideQrCode: result.result.cardUrl,
                        cardNumber: result.result.memberCard,
                        shopName: result.result.shopName,
                        brandName: result.result.brandName,
                    }
                    localStorage.setItem('showData', JSON.stringify(bean))
                    console.log("check:"+JSON.stringify("showData").toString())
                    //非新用户-跳转已经有导购界面
                    if(recruitInfo.guideId == result.result.sgGuideId){
                        //同一导购
                        window.location.replace("sameGuide.html")
                    }else{
                        //不同导购
                        window.location.replace("memberCard.html")
                    }
                }

            } else {
                // 跳转错误页
                alert(result.msg)
            }
        })
    }

    /**
     * 初始化微信JS-SDK参数
     */
    function initWXConfig() {
        this.ajax(backstageURL + '/getInitWXConfigParam', {url: location.href.split('#')[0]}).then(function (data) {
            wx.config(data.result);
        })
    }

    /**
     * 跳转会员领卡
     */
    function addCard(cardId) {
        this.ajax(backstageURL + '/getAddCardExtParam').then(function (data) {
            wx.addCard({
                cardList: [{
                    cardId: cardId,
                    cardExt: data.result
                }],
                success: function (res) {
                    var cardList = res.cardList; // 添加的卡券列表信息
                    // 跳转开卡成功页面
                    alert(JSON.stringify(cardList))
                    window.location.replace(getRootPath() + "addFriend.html")
                }
            });
        })
    }

    function ajax(url, data, params) {
        data = JSON.stringify(data)
        return new Promise(function (resolve, reject) {
            $.ajax({
                url: url,
                type: params && params.type || 'post',
                dataType: params && params.dataType || 'JSON',
                data: data,
                method: "post",
                contentType: "application/json;charset=UTF-8",
                success: function (res) {
                    resolve(res)
                },
                error: function (res) {
                    alert(res.m)
                }
            });
        });
    }
</script>
</body>
</html>
