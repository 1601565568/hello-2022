<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="format-detection" content="telephone=yes"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0,minimum-scale=1.0,user-scalable=0"/>
  <title>客户详情</title>
  <link rel="stylesheet" type="text/css" href="./src/index.css">
</head>
<body>
  <div class="customer-detail" hidden>
    <!-- 顶部状态栏 start -->
    <div class="page-status-bar text-center">
      <div class="state-bar__cancel cancel_customerDetail text-secondary">取消</div>
      <span class="text-title font-weight-medium">客户详情</span>
    </div>
    <!-- 顶部状态栏 end -->
    <div class="page-container">
      <div class="detail-head card">
        <div class="detail-head__avatar">
          <img class="customerImg" src="./src/images/default-user.png" alt="">
        </div>
        <div class="detail-head__info">
          <div class="text-title font-size-large font-weight-medium customerWechatNick">--</div>
          <div class="detail-head__icon">
            <img src="./src/icons/icon-boy.svg" class="customerBoy" alt="性别图标">
            <img src="./src/icons/icon-girl.svg" class="customerGirl hide" alt="性别图标">
          </div>
        </div>
      </div>
      <!-- 基本信息 start  -->
      <div class="detail-subtitle">基本信息</div>
      <div class="card detail-form font-size-base">
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">姓名</div>
          <div class="detail-form__content text-title customerName">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">性别</div>
          <div class="detail-form__content text-title customerSex">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">电话</div>
          <div class="detail-form__content text-title customerPhone">--</div>
          <div class="detail-form__addon customer-phone" hidden>
            <a id="customer-phone" href="">
              <img src="./src/icons/icon-telephone-fill.svg" alt="手机">
            </a>
          </div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">VIP等级</div>
          <div class="detail-form__content text-title customerGradeName">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">会员卡号</div>
          <div class="detail-form__content text-title customerMemberCard">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">微信号</div>
          <div class="detail-form__content text-title customerWechatNo">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">生日</div>
          <div class="detail-form__content text-title customerBirthday">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">专属导购</div>
          <div class="detail-form__content text-title customerGuideName">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">淘宝用户名</div>
          <div class="detail-form__content text-title customerTbNick">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">京东用户名</div>
          <div class="detail-form__content text-title customerJdNick">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">有赞用户名</div>
          <div class="detail-form__content text-title customerYzNick">--</div>
        </div>
<!--        <div class="detail-form__item">-->
<!--          <div class="detail-form__label text-secondary">会员印象</div>-->
<!--          <div class="detail-form__content text-title customerRemark">&#45;&#45;</div>-->
<!--          <div class="detail-form__addon tag-details__edit"><img src="./src/icons/icon-edit-fill.svg" alt="编辑"></div>-->
<!--        </div>-->
      </div>
      <!-- 基本信息 end  -->
      <!-- 客户财富 start  -->
      <div class="detail-subtitle">客户财富</div>
      <div class="card detail-form font-size-base customerMsg">
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">优惠券</div>
          <div class="detail-form__content text-title customerUsable">--</div>
        </div>
        <div class="detail-form__item">
          <div class="detail-form__label text-secondary">余额</div>
          <div class="detail-form__content text-title customerMoney">--</div>
        </div>
      </div>
      <!-- 客户财富 end  -->
    </div>
  </div>
  <div class="float-layout" hidden>
    <div class="float-layout__mask"></div>
    <div class="float-layout__main">
      <div class="float-layout__title">
        <div>会员印象</div>
        <div class="text-link float-layout__save">保存</div>
      </div>
      <div class="float-layout__content">
        <!-- 输入框 -->
        <div class="float-textarea">
          <textarea name="" placeholder="请输入会员印象"></textarea>
        </div>
      </div>
    </div>
  </div>
  <div class="customer-no-vip" hidden>
    <div class="page-status-bar text-center">
      <div class="state-bar__cancel cancel_customerDetail text-secondary">取消</div>
      <span class="text-title font-weight-medium">客户详情</span>
    </div>
    <!-- 顶部状态栏 end -->

    <!-- 不是会员 start -->
    <div class="page-container page-container--no-data">
      <img src="./src/images/not-vip.png" alt="not-vip">
      <div class="text-secondary font-size-small line-height-small customer-errormsg">此会员不是会员，无法查看客户资料~</div>
    </div>
    <!-- 不是会员 end -->
  </div>
<script type="text/javascript" src="https://hb3-shopguide.oss-cn-zhangjiakou.aliyuncs.com/commonJs/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="https://hb3-shopguide.oss-cn-zhangjiakou.aliyuncs.com/commonJs/common.js"></script>
<script>
  $('.tag-details__edit').click(function () {
    $('.float-layout').removeClass('hidden')
  })
  $('.float-layout__save').click(function () {
    $('.float-layout').addClass('hidden')
  })
  $('.float-layout__mask').click(function () {
    $('.float-layout').addClass('hidden')
  })

  $('.cancel_customerDetail').click(function () {
    var host = "ecrp://send?params="
    var params = '{"type":-1}'
    window.location.href = host+params
  })
  window.onload = function () {
    getCustomerDetail()
  }
  function getCustomerDetail() {
    let wxId = getPar('wxId')
    let chatId = getPar('chatId')
    this.ajax(backstageURL() + '/guideCustomer/customerDetail', {
      wxId: wxId,
      chatId: chatId,
    }).then(function (result) {
      if (result.success) {
        $(".customer-detail").show()
        if (result.result.customerHeadImage){
          $(".customerImg").attr("src",result.result.customerHeadImage)
        }
        $(".customerWechatNick").html(checkParams(result.result.wechatNick))
        $(".customerName").html(checkParams(result.result.customerName))
        $(".customerMemberCard").html(checkParams(result.result.customerMemberCard))
        $(".customerGuideName").html(checkParams(result.result.guideName))
        if (result.result.sex == -1) {
          $(".customerBoy").hide()
          $(".customerGirl").hide()
          $(".customerSex").html("未知")
        }else if (result.result.sex == 0) {
          $(".customerBoy").hide()
          $(".customerGirl").show()
          $(".customerSex").html("女")
        }else if (result.result.sex == 1) {
          $(".customerBoy").show()
          $(".customerGirl").hide()
          $(".customerSex").html("男")
        }
        $(".customerPhone").html(checkParams(result.result.mobile))
        if (result.result.mobile != '' && result.result.mobile != null){
          $(".customer-phone").show()
          $("#customer-phone").attr('href','tel:'+result.result.mobile)
        }
        $(".customerGradeName").html(checkParams(result.result.gradeName))
        $(".customerWechatNo").html(checkParams(result.result.wechatNo))
        if (result.result.birthday){
          $(".customerBirthday").html(result.result.birthday.substr(0,10))
        }else {
          $(".customerBirthday").html('--')
        }
        let platformInfos = result.result.platformInfos;
        for (let i = 0; i < platformInfos.length; i++) {
          let platformInfo = platformInfos[i];
          if (platformInfo.platform == 1){//淘宝类型
            $(".customerTbNick").html(checkParams(platformInfo.outNick))
          }
          if (platformInfo.platform == 3){//京东类型
            $(".customerJdNick").html(checkParams(platformInfo.outNick))
          }
          if (platformInfo.platform == 11){//有赞类型
            $(".customerYzNick").html(checkParams(platformInfo.outNick))
          }
        }
        if (result.result.usable){
          $(".customerUsable").html(result.result.usable)
        }else {
          $(".customerUsable").html(0)
        }
        $(".customerRemark").html(checkParams(result.result.impression))
        if (result.result.money){
          $(".customerMoney").html(checkParams(result.result.money))
        }else {
          $(".customerMoney").html(0)
        }
        let integralMsg = result.result.integralMsg;
        if (integralMsg){
          for (var i = 0;i < integralMsg.length;i++){
            let integral = integralMsg[i]
            var html = '<div class="detail-form__item">' +
              '      <div class="detail-form__label text-secondary">'+integral.integralAlias+'</div>' +
              '      <div class="detail-form__content text-title">'+integral.availPoint+'</div>' +
              '    </div>'
            $(".customerMsg").append(html)
          }
        }
      } else {
        // 跳转错误页
        $(".customer-detail").hide()
        let message = ""
        if (result.result) {
          message = result.result
        }
        if (message.indexOf('未找到相关用户') >= 0 || message.indexOf('客户不存在') >= 0 || message.indexOf('无此用户') >= 0 || message.indexOf('此好友不是会员') >= 0 || message.indexOf('该会员还未绑定会员卡') >= 0 ) {
          message = '当前聊天对象非会员，无法查看'
        }
        if (result.result){
          $(".customer-errormsg").html(message)
        }
        $(".customer-no-vip").show()
      }
    })
  }
  function ajax(url, data, params) {
    data = JSON.stringify(data)
    return new Promise(function (resolve, reject) {
      $.ajax({
        url: url,
        type: params && params.type || 'post',
        dataType: params && params.dataType || 'JSON',
        data: data,
        method: "post",
        contentType: "application/json;charset=UTF-8",
        success: function (res) {
          resolve(res)
        },
        error: function (res) {
          $(".customer-detail").hide()
          $(".customer-errormsg").html(res.result)
          $(".customer-no-vip").show()
        }
      });
    });
  }
  function checkParams(params) {
    if (params == null || params == ''){
      return '--'
    }else {
      return params
    }
  }
</script>
</body>
</html>
