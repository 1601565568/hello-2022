<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta content="user-scalable=no" id="viewport" name="viewport" />
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1.0, user-scalable=no"
          id="divport" name="viewport" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" href="index.css">
    <title>客户详情</title>
</head>
<body>
<div class="detail">
    <div class="detail__header">
        <img src="https://hb3-shopguide.oss-cn-zhangjiakou.aliyuncs.com/app/default-user.png"
             alt="用户头像" class="avatar customerHeadImage">
        <div class="uname customerName">-</div>
        <img src="" style='display: none' alt="性别" class="gender">
    </div>
    <div class="detail__content">
        <div class="content">
            <div class="content__title">姓名：</div>
            <div class="content__substance customerName">-</div>
        </div>
        <div class="content content--place">
            <div class="content__title">电话：</div>
            <div class="content__substance mobile">-</div>
            <a class='mobileA' href="javascript:void(0)"><img src="/mobile/img/expression/dianhua.png" alt="手机"
                                                              class="content__phone"></a>
        </div>
        <div class="content">
            <div class="content__title">VIP等级：</div>
            <div class="content__substance gradeName">-</div>
        </div>
        <div class="content">
            <div class="content__title">专属导购：</div>
            <div class="content__substance guideName">-</div>
        </div>
        <div class="content">
            <div class="content__title">所属门店：</div>
            <div class="content__substance shopName">-</div>
        </div>
        <div class="content">
            <div class="content__title">微信号：</div>
            <div class="content__substance wid">-</div>
        </div>
        <div class="content">
            <div class="content__title">生日：</div>
            <div class="content__substance birthday">-</div>
        </div>
        <div class="content">
            <div class="content__title">淘宝用户名：</div>
            <div class="content__substance outNick">-</div>
        </div>
        <div class="content">
            <div class="content__title">京东用户名：</div>
            <div class="content__substance">-</div>
        </div>
        <div class="content">
            <div class="content__title">有赞用户名：</div>
            <div class="content__substance">-</div>
        </div>
        <div class="content content--place content--padding">
            <div class="content__title">备注：</div>
            <!-- 未输入备注之前 -->
            <div class="content__substance impression">-</div>
            <!-- 输入备注 -->
            <!--<div class="content__pillar"></div>-->
            <textarea style='display: none' name="a" placeholder="请输入"
                      class="content__textarea impressionEdit"></textarea>
            <div class="content__substance content__substance--edit editButton" onclick='editRemark()'>编辑</div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="https://hb3-shopguide.oss-cn-zhangjiakou.aliyuncs.com/commonJs/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="https://hb3-shopguide.oss-cn-zhangjiakou.aliyuncs.com/commonJs/common.js"></script>
<script>
    let isEdit = true
    let saving = false
    let customerModel
    let ownerWid
    let wid
    const editRemark = function () {
        const $editButton = $('.editButton')
        const $impression = $('.impression')
        const $impressionEdit = $('.impressionEdit')
        if (saving) {
            return
        }
        if (isEdit) {
            isEdit = false
            $editButton.html('保存')
            $impression.hide()
            $impressionEdit.show()

        } else {
            saving = true
            const impression = $impressionEdit.val()
            fetch({
                url: 'wx/customer/edit',
                method: 'post'
            }, {
                customerId: customerModel.customerId,
                guideId: customerModel.guideId,
                impression: impression
            })
                .then(data => {
                    saving = false
                    isEdit = true
                    $editButton.html('编辑')
                    $impression.text(impression)
                    $impressionEdit.hide()
                    $impression.show()
                })
                .catch(error => {
                    saving = false
                    alert(error && error.msg ? error.msg : '未知异常')
                })

        }
    }
    const processSex = (sex) => {
        // 处理性别，性别 -1未知，0：女，1：男
        let url
        switch (sex) {
            case 0:
                url = '/mobile/img/expression/nv.png'
                break
            case 1:
                url = '/mobile/img/expression/nan.png'
                break
            default:
        }
        const $el = $('.gender')
        if (url) {
            $el.attr('src', url).show()
        } else {
            $el.hide()
        }
    }

    const typeMap = {
        customerHeadImage: {
            type: 'src',
            defaultValue: 'https://hb3-shopguide.oss-cn-zhangjiakou.aliyuncs.com/app/default-user.png'
        },
        sex: processSex,
        mobile: function (mobile) {
            if (mobile) {
                // todo-zsf 缺少手机号
                $('.mobileA').attr('href', 'tel:' + mobile)
            }
            return formatMobile(mobile)
        },
        impression: function (impression) {
            $('.impressionEdit').val(impression)
            $('.impression').text(impression)
        },
        birthday: function (birthday) {
            birthday = birthday || '-'
            if (birthday) {
                birthday = birthday.substr(0, 10)
            }
            return birthday
        }
    }

    const toError = (type = 3, message = '') => {
        window.location.href = '/mobile/prompt/prompt.html?type=' + type + '&message=' + encodeURIComponent(message)
    }
    $(function () {
        ownerWid = getPar('ownerWid')
        wid = getPar('wid')

        if (!ownerWid || !wid) {
            toError(3, '参数错误：个人号微信号或好友微信号都不允许空')
            return
        }

        fetch({
            url: 'wx/customer/getCustomerDetail',
            method: 'post'
        }, { ownerWid, wid })
            .then(data => {
                let customer = data.result
                if (!customer) {
                    toError(1, '未查到会员信息')
                    return
                }
                customerModel = customer
                Object.assign(customer, { wid: wid })
                Object.keys(customer).map(k => {
                    const type = typeMap[k]
                    const $el = $('.' + k)
                    let value = customer[k]
                    if ($el) {
                        if (type) {
                            if (typeof type === 'function') {
                                const temp = type(value)
                                if (!temp) {
                                    return
                                }
                                value = temp
                            } else if (typeof type === 'object') {
                                $el.attr(type.type, value || type.defaultValue)
                                return
                            } else {
                                $el.attr(type, value || '-')
                                return
                            }

                        }
                        $el.html(value || '-')
                    }
                })
            }).catch(error => {
            toError(3, error && error.msg ? error.msg : '')
        })
    })
</script>
</html>
