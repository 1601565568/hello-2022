<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=2.0, user-scalable=no"/>
  <meta http-equiv="Cache-Control" content="no-siteapp"/>
  <meta name="format-detection" content="telephone=no"/>
  <link rel="stylesheet" href="materialLibrary.css">
  <link rel="stylesheet" href="../css/iconfont.css">
  <link rel="stylesheet" href="../css/swiper.min.css">
  <title>素材库</title>
</head>
<body>
<div>
  <!-- 隐藏域 用于复制粘贴功能 -->
  <textarea id="input"></textarea>
</div>
<!-- 顶部状态栏 start -->
<div class="page-status-bar page-fixed">
  <span style="cursor: pointer;" class="state-bar__cancel">取消</span>
  <span class="font-weight-medium">素材库</span>
</div>
<!-- 顶部状态栏 end -->
<!-- 当搜索结果为暂无您要找的快捷话术，这边需要加个类名material--nospace，底部的间距为0，<div class="material material--nospace"> -->
<div class="material">
  <!-- 搜索栏 start -->
  <div class="material__search page-fixed">
    <div class="searchbar">
      <i class='iconfont icon-ns-search searchbar__icon'></i>
      <input type="text" placeholder="输入素材推广文案/文章标题" value="" class="searchbar__input"/>
      <i class='iconfont icon-shanchu1 searchbar__icon'></i>
    </div>
  </div>
  <!-- 搜索栏 end -->

  <!-- 素材分组 start -->
  <div class="material__choice page-fixed">
    所有素材
    <i class='iconfont icon-ns-arrow-drowdown'></i>
  </div>
  <!-- 素材分组 end -->

  <!-- 素材库列表 start -->
  <div class="material__list">
  </div>
  <!-- 素材库列表 end -->

  <!-- 暂无素材 start -->
  <div class="material__noData hidden"><!-- style="display: none;" -->
    <div class="prompt">暂无素材</div>
  </div>
  <!-- 暂无素材 end -->

  <!-- 发送按钮 start -->
  <div class="material__btn">
    <div class="send">发送</div>
  </div>
  <!-- 发送按钮 end -->
</div>

<div class="float-layout hidden">
  <div class="float-layout__mask"></div>
  <div class="float-layout__main">
    <div class="float-layout__title">
      <div>分组</div>
    </div>
    <div class="float-layout__content">
      <!-- 单选 -->
      <div class="float-select">
      </div>
    </div>
  </div>
</div>
<!-- 素材分组浮层 end -->

<!-- 复制成功 start -->
<div class="copy hidden"><!-- style="display: none;" -->
  <div class="copy__prompt">复制成功</div>
</div>
<!-- 复制成功 end -->

<!-- 图片大图切换 start -->
<!-- Swiper -->
<div class="swiper-container hidden">
  <!-- 顶部状态栏 start -->
  <div class="page-bar-return page-fixed">
    <i class='iconfont icon-return swiper-return'></i>
    <span class="swiper-number"></span><!-- 2/9 -->
  </div>
  <!-- 顶部状态栏 end -->
  <div class="swiper-wrapper">
  </div>
</div>
<!-- 图片大图切换 end -->

<script src="../js/jquery-3.4.1.min.js"></script>
<script src="./swiper.min.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script>
  var host = "ecrp://send?params="
  // 查询素材分组URL
  let findSubdivisionListUrl = '/wx/material/findH5SubdivisionList';
  // 查询素材列表URL
  let findMaterialListUrl = '/wx/material/findH5MaterialList';
  // 发送素材
  let sendMaterialUrl = '/wx/material/sendMaterial';
  // 获取图片二维码
  let getAppletImageUrl = '/wx/material/getAppletImage';
  // 分组列表
  let subdivisionList = []
  // 搜索条件
  let searchName = null
  // 选中的分组Id
  var selectedSubdivisionId = null
  var selectedSubdivisionName = "所有素材"
  // 选中的素材Id
  let selectedId = null
  let selectedMaterial = {}
  // 当前好友微信ID
  let chatId
  // 当前员工的微信ID
  let wxId
  // 当前员工的公司ID
  let groupId
  // 员工工作门店ID
  let shopId
  // 分页大小
  let pageStart = 0
  let pageSize = 15
  /**
   * @msg: 页面初始化加载事件
   * 1、查询素材分组 & 组装素材分组数据
   * 2、查询素材列表 & 组装素材列表数据 （素材分组类型：品牌/门店）
   */
  window.onload = function () {
    document.addEventListener('touchmove',function(e){
      var canScroll=false;
      if(!canScroll){
        e.preventDefault()
      }
    })
    // 页面数据初始化
    this.init();
  }
  /**
   * @msg: 下拉加载更多
   */
  window.onscroll = function() {
    // 文档内容实际高度（包括超出视窗的溢出部分）
    var scrollHeight = Math.max(document.documentElement.scrollHeight, document.body.scrollHeight);
    //滚动条滚动距离
    var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
    //窗口可视范围高度
    var clientHeight = window.innerHeight || Math.min(document.documentElement.clientHeight, document.body.clientHeight);

    if (clientHeight + scrollTop >= scrollHeight) {
      initMaterialList(++pageStart)
    }
  }
  /**
   * @msg: 页面数据初始化
   */
  function init() {
    // 获取当前员工的微信ID
    // wxId = getPar('wxId')
    chatId = 'yy_xm1028'
    // chatId = getPar('chatId')
    // shopId = getPar('shopId')
    shopId = 1002247
    wxId = 'wxid_gilg2xu6f0p322'
    if (!chatId || !wxId) {
        toError(3, '参数错误：个人号微信号或好友微信号都不允许空')
        return
    }
    // if (!shopId) {
    //     toError(3, '参数错误：工作门店不允许空')
    //     return
    // }
    // 初始化分组
    initSubdivisionList()
    // 初始化素材列表
    initMaterialList()
  }
  /**
   * @msg: 重置
   */
  function resetParam() {
    pageStart = 0
    $(".material__list").html('');
    showNoData(false)
  }
  /**
   * @msg: 初始化分组列表
   */
   function initSubdivisionList() {
    this.ajax(apiRoot() + findSubdivisionListUrl,
      {
        wxId: wxId,   // 链接直接获取
      }).then(function (result) {
        if (result.success) {
          // 分组列表
          this.subdivisionList = result.result
          // 素材列表组装 & 展示
          let html =
              '<div class="float-select__item">' +
                '<div class="float-select__content">所有素材</div>' +
                '<div class="subdivision__class page-radio page-radio--selected"></div> <!-- page-radio--selected -->' +
              '</div>';
          if (this.subdivisionList && this.subdivisionList.length > 0) {
            this.subdivisionList.forEach(function(subdivision,index,arr){
              html +=
                '<div class="float-select__item">' +
                  '<div class="float-select__content">' + subdivision.subdivision_name + '</div>' +
                  '<div class="subdivision__class page-radio" subdivision-name="' + subdivision.subdivision_name + '" subdivision-id="' + subdivision.subdivision_id + '"></div>' +
                '</div>';
            })
          }
          $(".float-select").html(html);
        } else {
          // 跳转错误页
          toError(3, error && error.msg ? error.msg : '')
        }
    })
  }
  /**
   * @msg: 初始化素材列表
   */
  function initMaterialList (pageStart = 0) {
    let $searchName = $('.searchbar__input');
    let selectedSubdivisionId = getSelectedSubdivisionId();
    this.ajax(apiRoot() + findMaterialListUrl,
      {
        wxId: wxId,   // 链接直接获取
        searchName: $searchName.val().trim(),
        subdivision_id: selectedSubdivisionId,
        pageStart: pageStart*pageSize,
        pageSize: pageSize
      }).then(function (result) {
        if (result.success) {
          // 素材列表
          let materialList = result.result
          // 素材列表组装 & 展示
          if (materialList && materialList.length > 0) {
            groupId = materialList[0].brandId
            let html = '';
            materialList.forEach(function(material,index,arr){
              html += buildListItem(
                material.id,
                material.content,
                material.imageList,
                material.create_time, // 时间
                "品牌",     // 品牌 or 门店
                material.subdivision_name ? material.subdivision_name : '-',
                index === 0 && pageStart === 0
                );
            })
            if (pageStart > 0) {
              $(".material__list").append(html);
            } else {
              $(".material__list").html(html);
            }

            // 异步生成二维码
            materialList.forEach(function(material,index,arr){
              if(material.codeTarget && material.m_type === 1){
                let params = {groupId: groupId, shopId : shopId, materialId : material.id, wxId : wxId}
                this.ajax(apiRoot() + getAppletImageUrl, params).then(res =>{
                  if (res.success) {
                    console.log(res.result)
                    replaceListItem(
                      material.id,
                      material.content,
                      res.result,
                      material.create_time, // 时间
                      "品牌",     // 品牌 or 门店
                      material.subdivision_name ? material.subdivision_name : '-',
                      index === 0 && pageStart === 0
                    );
                  } else {
                    toError(3, res.msg ? res.msg : '')
                  }
                })
              }
            })
            return
          } else {
            if (pageStart === 0) {
              // 暂无数据
              showNoData(true)
            }
          }
        } else {
          // 跳转错误页
          toError(3, error && error.msg ? error.msg : '')
        }
    })
  }
  // 替换元素
  function replaceListItem(materialId, content, imageList, datetime, type, subdivision, isSelected) {
    let oldNode = document.getElementById(materialId);
    if (oldNode) {
      oldNode.parentNode.replaceChild(
        parseDom(buildListItem(materialId, content, imageList, datetime, type, subdivision, isSelected))[0], oldNode)
    }
  }
  /**
   * @msg: 构建列表选项
   * @param content 文本内容
   * @param imageList 图片列表
   * @param datetime 时间
   * @param type 类型 品牌/门店
   * @param subdivision 分组名称
   * @return: 返回列表项的dom文本
   */
  function buildListItem(materialId, content, imageList, datetime, type, subdivision, isSelected) {
    if (isSelected) {
      selectedId = materialId;
      selectedMaterial = Object.assign({}, {
        materialId: materialId,
        content: content,
        imageList:  JSON.stringify(imageList)
      })
    }
    let cls = isSelected ? 'page-radio--selected' : ''
    let html =
    '<div class="item" id="' + materialId + '">' +
      '<div class="material__class page-radio ' + cls + '"'
        + ' materialId="' + materialId + '"'
        + ' content="' + content + '"'
        + ' imageList="' + imageList + '"' + '></div>' +
      '<div class="item__msg">' +
          // 主内容
          '<div class="outerContainer">' +
            '<div class="subCategory">' +
              ' <div class="title">' + content + '</div>' +
            '</div>' +
          '</div>' +
          // 展开按钮
          '<div class="subCategoryMore">' +
            '<span class="modify">展开</span>' +
          '</div>' +
          // 照片List 组装
          '<div class="photowall">' +
             this.buildImageList(imageList) +
          '</div>' +
          // 创建时间加分组展示 2019年10月11日 11:30:51 | 门店/分组A也是分享到分组分组A也是分享到分组
          '<div class="other">' +
            '<div class="other__time">' + datetime + '</div>' +
            '<div class="other__store">' + type + '/' + subdivision + '</div>' +
          '</div>' +

          // '<div class="share" materialId="' + materialId + '">' +
          //   '<i class="iconfont icon-ns-share"></i>' +
          //   '分享到朋友圈' +
          // '</div>' +

        '</div>' +
      '</div>'
    return html;
  };
  /**
   * @msg: 构建图片列表选项
   * @param Array 图片列表
   */
  function buildImageList(imageList) {
    let html = '';
    if (!imageList || imageList.length <= 0) {
      return html;
    }
    imageList.forEach(function(image,index,arr){
      html +=
      '<div class="photowall__picture">' +
        '<img src="' + image + '" alt="素材库图片" class="img" index="' + index + '" imageList="' + imageList + '">' +
      '</div>';
    })
    return html;
  };
  /**
   * @msg: 获取选中的分组ID
   */
  function getSelectedSubdivisionId() {
    let selected = null
    $('.subdivision__class').each(function(i,e){
      if ($(e).hasClass('page-radio--selected')) {
        selected = e.getAttribute('subdivision-id');
        return
      }
    })
    return selected
  }
  /**
   * @msg: 暂无数据
   */
  function showNoData(noData = true) {
    if (noData) {
      $('.material__noData').removeClass('hidden');
    } else {
      $('.material__noData').addClass('hidden');
    }
  }
  /**
   * @msg: 复制成功
   */
   function showCopyMsg() {
    $('.copy').removeClass('hidden');
    setTimeout(function () {
      $('.copy').addClass('hidden');
    }, 1000)
  }
  /**
   * @msg: 图片轮播
   */
  function buildSwiperImageList(imageList, i) {
    let html = '';
    if (!imageList || imageList.length <= 0) {
      return html;
    }
    imageList.forEach(function(image,index,arr){
      html +=
      '<div class="swiper-slide">' +
        '<img src="' + image + '" alt="素材库图片" class="full-img">' +
      '</div>';
    })
    $('.swiper-wrapper').html(html);
    $('.swiper-number').html(i + '/' + imageList.length);
  }
  function parseDom(nodelist) {
    var objE = document.createElement("div")
    objE.innerHTML = nodelist;
    return objE.childNodes;
  }
  /**
    * 事件绑定
    */
  // 取消
  $('.state-bar__cancel').click(function () {
    let params = '{"type":-1}'
    window.location.href = host + params
  })
  // 查询
  $('.icon-ns-search').click(function () {
    resetParam();
    initMaterialList();
  })
  // 删除查询参数
  $('.icon-shanchu1').click(function () {
    if ($('.searchbar__input').val() === '') {
      return
    }
    $('.searchbar__input').val('')
  })
  // 素材radio选择 动态dom元素事件监听
  $(document).on('click', '.material__class', function(e){
    selectedId = $(e.target).attr("materialId");
    selectedMaterial = Object.assign({}, {
      materialId: $(e.target).attr("materialId"),
      content: $(e.target).attr("content"),
      imageList: $(e.target).attr("imageList")
    })
    $('.material__class').each(function(i,e){
      if ($(e).attr("materialId") === selectedId) {
        $(e).addClass('page-radio--selected');
      } else {
        $(e).removeClass('page-radio--selected');
      }
    })
  });
  // 分组radio选择 动态dom元素事件监听
  $(document).on('click', '.subdivision__class', function(e){
    let selectedSubdivisionId = getSelectedSubdivisionId()
    let tempId = $(e.target).attr("subdivision-id");
    if ((!selectedSubdivisionId && !tempId) || (selectedSubdivisionId === tempId)) {
      return
    }
    //从非空到非空 从空到非空
    if ((selectedSubdivisionId && tempId) || (!selectedSubdivisionId && tempId)) {
      $('.subdivision__class').each(function(i,e){
        if (e.getAttribute('subdivision-id') === tempId) {
          $(e).addClass('page-radio--selected');
          selectedSubdivisionName = e.getAttribute('subdivision-name');
        } else {
          $(e).removeClass('page-radio--selected');
        }
      })
    }
    // 从非空到空
    if (selectedSubdivisionId && !tempId) {
      selectedSubdivisionName = "所有素材";
      $('.subdivision__class').each(function(i,e){
        if (!e.getAttribute('subdivision-id')) {
          $(e).addClass('page-radio--selected');
        } else {
          $(e).removeClass('page-radio--selected');
        }
      })
    }
    selectedSubdivisionId = tempId
    $(".material__choice").text(selectedSubdivisionName)
    resetParam();
    // 加载列表
    initMaterialList()
  });
  // 素材分组打开浮层
  $('.material__choice').click(function () {
    $('.float-layout').removeClass('hidden');
    $('body').css('overflow','hidden');
  })
  // 素材分组关闭浮层
  $('.float-layout__mask').click(function () {
    $('.float-layout').addClass('hidden')
    $('body').css('overflow','auto');
  })
  // 判断素材组标题超过三行显示图标
  $(".subCategory").each(function(){
    var innerHeight = $(this).outerHeight(true);
    if (innerHeight > 60) {
      $(this).parent().siblings(".subCategoryMore").css("display","block");
    }
  });
  // 素材标题收起和隐藏
  $('.subCategoryMore').click(function () {
    var show = $(this).parent().hasClass('is_open');
    if (!show) {
      $(this).children().text('收缩');
    } else {
      $(this).children().text('展开');
    }
    $(this).parent().toggleClass('is_open');
  })
  /**
   * @msg: 复制文本
   *    <textarea id="input">这是幕后黑手</textarea>
   */
  $(document).on('click', '.title', function(e){
    let content = $(e.target).html()
    var input = document.getElementById("input");
    input.value = content; // 修改文本框的内容
    input.select(); // 选中文本
    document.execCommand("copy"); // 执行浏览器复制命令
    showCopyMsg(true)
  })
  /**
   * @msg: 图片点击大图
   */
  $(document).on('click', '.photowall__picture', function(e){
    $('.page-status-bar').addClass('hidden');
    $('.material').addClass('hidden');
    $('.swiper-container').removeClass('hidden');
    // 图片轮播
    var swiper = new Swiper('.swiper-container');
    // 组装图片轮播
    let imageList = e.target.getAttribute('imageList');
    let index = e.target.getAttribute('index');
    if (imageList) {
      buildSwiperImageList(imageList.split(','), parseInt(index) + 1);
    }
  })
  // 大图图片点击关闭
  $(document).on('click', '.swiper-return', function(e){
    $('.swiper-container').addClass('hidden');
    $('.page-status-bar').removeClass('hidden');
    $('.material').removeClass('hidden');
  })
  /**
   * @msg: 发送素材 文本 + 图片
   * http://www.baidu.com?wxid={wxId}&friend={chatId}
   * 文本：'{"type":1,"content":"文本内容","exit":true}';
   * 图片：'{"type":2,"picUrl":"图片大图链接地址","smallPicUrl":"图片缩略图链接地址","exit":true}'
   */
  $('.send').click(function () {
    if (!selectedMaterial) {
      return
    };
    let exit = false;
    if (selectedMaterial.content) {
      let content = '{"type":1,"content":"' + selectedMaterial.content + '","exit":false}';
      window.location.href = host + content
    }
    if (selectedMaterial.imageList) {
      selectedMaterial.imageList.split(",").forEach(function(image,index,arr){
        content = '{"type":1,"picUrl":"' + image + '","exit":false}';
        window.location.href = host + content
      });
    }
    let params = '{"type":-1}'
    window.location.href = host + params
  })
  // 分享到朋友圈
  $(document).on('click', '.share', function(e){
    let materialId = $(e.target).attr("materialId")
    alert("分享到朋友圈:" + materialId)
  })
  /**
   * @msg: http请求封装
   */
  function ajax(url, data, params) {
    data = JSON.stringify(data)
    return new Promise(function (resolve, reject) {
      $.ajax({
        url: url,
        type: params && params.type || 'post',
        dataType: params && params.dataType || 'JSON',
        data: data,
        method: "post",
        contentType: "application/json;charset=UTF-8",
        success: function (res) {
          resolve(res)
        },
        error: function (res) {
          toError(3, error && error.msg ? error.msg : '')
        }
      });
    });
  }
  /**
   * @msg: 跳转到错误页面
   * redirectUrl：页面刷新参数
   */
  const toError = (type = 3, message = '') => {
    window.location.href = '/mobile/prompt/prompt.html?type=' + type + '&message=' + encodeURIComponent(message)
  }
  function ajax(url, data, params) {
    data = JSON.stringify(data)
    return new Promise(function (resolve, reject) {
      $.ajax({
        url: url,
        type: params && params.type || 'post',
        dataType: params && params.dataType || 'JSON',
        data: data,
        method: 'post',
        contentType: "application/json;charset=UTF-8",
        success: function (res) {
          resolve(res)
        },
        error: function (res) {
          $(".fail").show();
          $('.fail__text').html(res.result);
        }
      });
    });
  }
  </script>
  </body>
</html>
