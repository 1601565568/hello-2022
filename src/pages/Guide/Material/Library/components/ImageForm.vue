<template>
  <div class="library-image">
    <el-form ref="form" :model="model" :rules="rules" label-width="100px">
      <el-form-item label="素材标题：" prop="name">
        <el-input
          type="textarea"
          maxlength="150"
          v-model="model.name"
          placeholder="请输入标题，长度在150个字符以内"
          style="width: 260px"
          :input="(model.name = model.name.replace(/\s+/g, ''))"
          clearable
        ></el-input>
      </el-form-item>
      <el-form-item label="选择标签：" prop="subdivisionId">
        <el-select
          v-model="model.subdivisionIds"
          placeholder="请选择"
          filterable
          style="width: 260px"
          multiple
          collapse-tags
        >
          <el-option
            v-for="item in labelList"
            :key="item.subdivisionId"
            :label="item.subdivisionName"
            :value="item.subdivisionId"
          >
          </el-option>
        </el-select>
        <span class="library-icon__extra" @click="toggleLabel">
          <Icon type="plus" />
          <span>添加标签</span>
        </span>
      </el-form-item>
      <el-form-item label="推广文案：" prop="content">
        <el-input
          resize="none"
          type="textarea"
          maxlength="1500"
          v-model="model.content"
          placeholder="可在此输入推广文案，限制长度在1500个字符以内。"
          style="width: 340px"
        ></el-input>
      </el-form-item>
      <el-form-item ref="imageForm" label="素材图片：" prop="mediaList">
        <ul class="library-image__list clearfix" style="z-index:200">
          <li
            class="library-image__item"
            v-for="(item, index) in mediaList"
            :key="index"
          >
            <img v-if="item.pitType == 2" :src="defaultImgUrl + '?x-oss-process=image/resize,m_mfit,h_200,w_200'" />
            <img v-else :src="item.url + '?x-oss-process=image/resize,m_mfit,h_200,w_200'" />
            <div class="library-image__mask">
              <div v-if="item.pitType == 1">
                <Icon type="zoom-in" @click="previewImage(index)" />
                <Icon type="delete" @click="removeImage(index)" />
              </div>
              <div v-else>
                <Icon type="bianji" @click="editImage(index)" />
                <Icon type="delete" @click="removeImage(index)" />
              </div>
            </div>
          </li>
          <li v-if="mediaList.length < imageNum">
            <el-popover
              placement="top-start"
              width="160"
              trigger="click"
              ref="popoverView"
            >
              <div class="library-popover">
                <div>
                  <el-upload
                    class="library-uploader"
                    :action="this.$api.core.sgUploadFile('image')"
                    :show-file-list="false"
                    :on-success="handleAvatarSuccess"
                    :before-upload="beforeGuideUpload"
                    accept=".jpg,.jpeg,.png"
                    list-type="picture-card"
                    multiple
                  >
                    <div class="popover-base">
                      <Icon type="tupianbeifen-5" class="popover-icon"></Icon>
                      <span class="popver-text">图片</span>
                    </div>
                  </el-upload>
                </div>
                <div class="popover-base" @click="addCustomImg">
                  <Icon type="ns-edit" class="popover-icon"></Icon>
                  <span class="popver-text">自建坑位</span>
                </div>
              </div>
              <div class="library-select-uploader" slot="reference">
                <div class="el-upload--picture-card">
                  <Icon type="plus" />
                </div>
              </div>
            </el-popover>
          </li>
        </ul>
        <div class="library-icon__extra">
          <Icon type="tishi" />
          <span
            >上传图片不能大于1MB；图片最多上传9张（加小程序码的最多8张）</span
          >
        </div>
      </el-form-item>
      <el-form-item label="小程序链接：" prop="codeModule">
        <el-select
          v-model="model.codeModule"
          placeholder="请选择"
          clearable
          @change="codeModuleChange"
          style="width: 240px"
        >
          <el-option
            v-for="item in wechatPageTypeList"
            :key="item.id"
            :label="item.name"
            :value="item.id"
          >
          </el-option>
        </el-select>
        <el-form-grid v-if="model.codeModule == 1">
          <el-select
            v-model="model.codeTarget"
            placeholder="请选择"
            clearable
            @change="codeTargetChange"
          >
            <el-option
              v-for="item in wechatPageUrlList"
              :key="item.codeTarget"
              :value="item.codeTarget"
              :label="item.codeTargetName"
            >
            </el-option>
          </el-select>
        </el-form-grid>
        <el-form-grid v-if="model.codeModule == 2">
          <ns-button @click="selectGoods" type="primary">选择商品</ns-button>
        </el-form-grid>
        <el-form-grid v-if="model.codeModule == 4">
          <ns-button @click="selectMarket" type="primary"
            >选择营销活动</ns-button
          >
        </el-form-grid>
      </el-form-item>
      <el-form-item
        v-if="
          model.codeModule &&
            model.codeModule != 1 &&
            model.codeTargetName != ''
        "
        :label="
          model.codeModule == 2
            ? '商品名称：'
            : model.codeModule == 4
            ? '活动名称：'
            : ''
        "
        prop="codeTargetName"
      >
        <el-input
          v-model="model.codeTargetName"
          :disabled="true"
          style="width: 240px"
        ></el-input>
      </el-form-item>
      <el-form-item
        label="小程序码类型："
        prop="codeType"
        v-if="model.codeTarget"
      >
        <el-radio-group v-model="model.codeType">
          <el-radio :label="1">图片上植入小程序码 </el-radio>
          <el-radio :label="2">单独增加一张小程序码图 </el-radio>
        </el-radio-group>
        <div
          v-if="model.codeType == 2"
          style="line-height:1.5;"
          class="library-icon__extra"
        >
          <Icon type="info-circle" />
          <span>生成一张新的小程序码图片，需门店里有对应信息的才会显示</span>
        </div>
      </el-form-item>
      <el-form-item label="保存到：">
        <span class="library-catalogue__text">{{ catalogueStr }}</span>
        <ns-button type="primary" @click="toggleFolder">选择文件夹</ns-button>
      </el-form-item>
    </el-form>
    <div class="library-footer">
      <ns-button type="primary" :loading="loading" @click="onSave"
        >保存</ns-button
      >
      <ns-button @click="onBack()">取消</ns-button>
    </div>
    <folder-tree
      ref="folderTree"
      title="选择文件夹"
      @submit="handleFolder"
    ></folder-tree>
    <SelectMarket
      ref="selectMarket"
      :callBack="selectMarketBack"
    ></SelectMarket>
    <SelectGoods ref="selectGoods" :callBack="selectMarketBack"></SelectGoods>
    <el-dialog
      :visible="showEdit"
      title="指南"
      width="658px"
      @close="handleCloseDia"
    >
      <div>
        <div class="guide-text">指南说明</div>
        <tag-area :maxlength="1000" placeholder="请输入" :showEmoji='true' v-model="guideText" :tools='tools'></tag-area>
        <!-- <el-input
          class="library-guide-remind"
          type="textarea"
          placeholder="请输入"
          v-model="guideText"
          maxlength="1000"
          show-word-limit
          resize="none"
        >
        </el-input> -->
      </div>
      <div>
        <div class="guide-text">示意图</div>
        <div class="upload-view">
          <el-upload
            class="library-guide"
            drag
            :action="this.$api.core.sgUploadFile('image')"
            :on-success="handleGuideSuccess"
            :before-upload="beforeAvatarUpload"
            :file-list="showEidtImg"
            :on-remove="removeGuideImg"
          >
            <div>
              <Icon type="cloud-uploading" class="uploading-icon" />
              <div class="el-upload-remind">点击或拖拽上传示意图</div>
              <div class="el-upload-remind" slot="tip">
                （建议：小于1M，jpg、png、jpeg格式）
              </div>
            </div>
          </el-upload>
        </div>
      </div>
      <div slot="footer" class="dialog-footer">
        <ns-button @click="handleCloseDia">取消</ns-button>
        <ns-button type="primary" @click="handleSure">确定</ns-button>
      </div>
    </el-dialog>
    <GuideInfo ref="guideInfo" />
  </div>
</template>
<script>
import FolderTree from './FolderTree'
import ElUpload from '@nascent/nui/lib/upload'
import { getErrorMsg } from '@/utils/toast'
import SelectMarket from '../../components/selectMarket'
import SelectGoods from '../../components/selectGoods'
import GuideInfo from './GuideInfo'
import TagArea from '@/components/NewUi/TagArea'
export default {
  name: 'imageform',
  // components: { FolderTree, SelectMarket, SelectGoods },
  components: { FolderTree, ElUpload, SelectMarket, SelectGoods, GuideInfo, TagArea },
  props: {
    labelList: {
      type: Array,
      default () {
        return []
      }
    },
    breadcrumb: {
      type: Array,
      default () {
        return []
      }
    },
    detail: {
      type: Object,
      default () {
        return {}
      }
    }
  },
  data: function () {
    return {
      loading: false,
      wechatPageTypeList: [
        { name: '商城主页面', id: 1 },
        { name: '商品', id: 2 },
        { name: '营销活动', id: 4 }
      ],
      wechatPageUrlList: [
        { codeTargetName: '首页', codeTarget: '1' },
        { codeTargetName: '分类', codeTarget: '2' },
        { codeTargetName: '我的', codeTarget: '3' }
      ],
      model: {
        isDirectory: 0,
        name: '',
        content: '',
        subdivisionIds: null,
        codeType: 1,
        marketType: null,
        codeModule: null,
        extJson: '',
        codeTarget: '',
        codeTargetName: '',
        mediaList: [],
        materialScriptType: 1,
        isUpdate: 0
      },
      rules: {
        name: [
          {
            required: true,
            message: '请输入标题',
            trigger: ['blur', 'change']
          },
          {
            min: 0,
            max: 150,
            message: '限制长度在150个字符以内',
            trigger: ['blur', 'change']
          }
        ],
        content: [
          {
            required: true,
            message: '请输入推广文案',
            trigger: ['blur', 'change']
          },
          {
            min: 0,
            max: 1500,
            message: '限制长度在1500个字符以内',
            trigger: ['blur', 'change']
          }
        ],
        mediaList: [
          { required: true, message: '请添加素材图片', trigger: 'change' }
        ]
      },
      mType: 1,
      imageNum: 9,
      catalogue: [{ id: 0, name: '素材库' }],
      visible: false,
      defaultImgUrl:
        'https://hb3-shopguide.oss-cn-zhangjiakou.aliyuncs.com/image/material/custom-edit.png',
      showEdit: false,
      guideText: '',
      drawer: false,
      editIndex: 0,
      showEidtImg: [],
      tools: []
    }
  },
  computed: {
    catalogueStr () {
      return this.catalogue.map(o => o.name).join(' > ')
    },
    mediaList () {
      return this.model.mediaList.slice(0, this.imageNum)
    }
  },
  watch: {
    detail (newObj) {
      const parentIds = newObj.parentPath.split('/')
      const parentNames = newObj.parentPathName.split('/')
      const tempModel = {}
      Object.keys(this.model).forEach(k => {
        tempModel[k] = !newObj[k] ? this.model[k] : newObj[k]
        // if (k === 'mediaList') {
        //   tempModel[k] = tempModel[k].filter(v =>
        //     /\.(jpg|jpeg|png|JPG|PNG|JPEG)$/.test(v)
        //   )
        // }
      })
      this.model = tempModel
      this.model.isUpdate = 1
      this.catalogue = parentIds.map((id, index) => ({
        id: +id,
        name: parentNames[index]
      }))
    },
    'model.codeType' (newVal) {
      this.imageNum = newVal === 2 ? 8 : 9
    }
  },
  methods: {
    removeGuideImg () {
      let item = this.mediaList[this.editIndex]
      item.url = ''
      this.mediaList.splice(this.editIndex, 1)
    },
    handleSure () {
      // 根据选中下标更新用户信息
      // let item = this.mediaList[this.editIndex]
      // if (item) {
      //   item.pitText = this.guideText
      // }
      if (this.model.mediaList.length < this.imageNum) {
        let item = this.model.mediaList[this.editIndex]
        if (item) {
          item.pitText = this.guideText
          item.url = this.defaultImgUrl
          this.model.mediaList[this.editIndex] = item
        } else {
          let obj = {
            pitType: 2,
            pitText: this.guideText,
            type: 1,
            url: this.defaultImgUrl
          }
          this.model.mediaList.push(obj)
        }
      }
      this.showEdit = false
    },
    handleCloseDia () {
      this.showEdit = false
    },
    editImage (index) {
      this.editIndex = index
      let item = this.mediaList[index]
      this.guideText = item.pitText ? item.pitText : ''
      let fileArr = item.url.split('/')
      this.showEidtImg = [{ name: fileArr.pop(), url: item.url }]
      // this.$refs.guideInfo.closeDeawer()
      this.showEdit = !this.showEdit
    },
    handleImageType () {
      this.visible = !this.visible
    },
    toggleFolder () {
      this.$refs.folderTree.show(null, this.catalogue)
    },
    toggleLabel () {
      this.$emit('toggleLabel')
    },
    previewImage (index) {
      this.$emit('togglePreview', index, this.mediaList, 'img')
    },
    handleFolder ({ catalogue }) {
      this.catalogue = catalogue
    },
    removeImage (index) {
      this.model.mediaList.splice(index, 1)
      this.$refs.form.validateField('mediaList')
    },
    handleAvatarSuccess (res, file) {
      this.$refs.imageForm.clearValidate()
      this.$refs.popoverView.doClose()
      if (this.model.mediaList.length < this.imageNum) {
        let obj = {
          pitType: 1,
          pitText: '',
          type: 1,
          url: res.result.url
        }
        this.model.mediaList.push(obj)
      }
    },
    handleGuideSuccess (res, file) {
      let item = this.mediaList[this.editIndex]
      item.url = res.result.url
    },
    addCustomImg () {
      // 添加坑位
      this.$refs.imageForm.clearValidate()
      this.$refs.popoverView.doClose()
      this.guideText = ''
      this.editIndex = this.model.mediaList.length
      this.showEdit = true
      // if (this.model.mediaList.length < this.imageNum) {
      //   let obj = {
      //     pitType: 2,
      //     pitText: '',
      //     type: 1,
      //     url: this.defaultImgUrl
      //   }
      //   this.model.mediaList.push(obj)
      // }
    },
    beforeGuideUpload (file) {
      this.beforeAvatarUpload(file)
      this.$refs.popoverView.doClose()
    },
    beforeAvatarUpload (file) {
      // 图片格式判断
      if (!/\.(jpg|jpeg|png|JPG|PNG|JPEG)$/.test(file.name)) {
        this.$notify.error('仅支持jpg/jpeg/png的图片格式')
        return false
      }
      // 图片大小判断
      if (file.size / 1024 > 1024) {
        this.$notify.warning('上传图片不得大于1MB')
        return false
      }
    },
    codeModuleChange (e) {
      this.$set(this.model, 'codeTarget', '')
      this.$set(this.model, 'codeTargetName', '')
    },
    codeTargetChange (e) {
      let codeTargetObj = e ? this.wechatPageUrlList[Number(e) - 1] : {}
      this.$set(
        this.model,
        'codeTargetName',
        codeTargetObj.codeTargetName || ''
      )
    },
    selectMarket () {
      this.$nextTick(() => {
        this.$refs.selectMarket.showToggle()
      })
    },
    selectGoods () {
      this.$nextTick(() => {
        this.$refs.selectGoods.showToggle()
      })
    },
    selectMarketBack (obj) {
      if (obj.activityId) {
        this.$set(this.model, 'codeTarget', obj.activityId)
        this.$set(this.model, 'codeTargetName', obj.activityName)
        this.$set(this.model, 'marketType', obj.marketType)
      } else if (obj.sysItemId) {
        this.$set(this.model, 'codeTarget', obj.sysItemId)
        this.$set(this.model, 'codeTargetName', obj.title)
        this.$set(
          this.model,
          'extJson',
          JSON.stringify({ mallId: obj.mallId, bankId: obj.bankId })
        )
      }
    },
    onBack (isSave) {
      this.$emit('back', isSave ? this.catalogue : null)
    },
    onSave () {
      this.$refs.form.validate(valid => {
        if (valid) {
          this.doSave()
        }
      })
    },
    doSave () {
      const params = { ...this.detail, ...this.model, mType: this.mType }
      // 控制图片数量
      params.mediaList = this.mediaList
      // 带码状态
      if (params.codeTarget === '') {
        params.codeType = 0
      }
      params.materialScriptType = 1
      for (let i = 0; i < params.mediaList.length; i++) {
        let item = params.mediaList[i]
        if (item.pitType === 2) {
          params.materialScriptType = 2
          break
        }
      }
      params.parentId = this.catalogue[this.catalogue.length - 1].id

      this.loading = true
      // 校验推广内容是否是纯空格 或换行
      let tempContent = this.model.content
      if (tempContent.replace(/\s+|[\r\n]/g, '').length === 0) {
        this.$notify.error('保存失败，推广文案不能输入纯空格或换行')
        this.loading = false
        return
      }
      this.$http
        .fetch(this.$api.guide.materialEdit, params)
        .then(resp => {
          this.$notify.success('保存成功')
          this.onBack(true)
        })
        .catch(resp => {
          this.$notify.error(getErrorMsg('保存失败', resp))
        })
        .finally(() => {
          this.loading = false
        })
    }
  },
  mounted () {
    this.catalogue =
      this.breadcrumb && this.breadcrumb.length
        ? this.breadcrumb
        : [{ id: 0, name: '素材库' }]
  }
}
</script>
<style scoped>
@import '@theme/variables.pcss';
.guide-text {
  height: 22px;
  font-size: 14px;
  color: #595959;
  line-height: 22px;
  font-weight: 400;
  margin-bottom: 8px;
  margin-top: 16px;
}
.guide-input {
  height: 140px;
}
.upload-view {
  width: 100%;
  background: #f5f5f5;
  border-radius: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
}

@component-namespace library {
  @b image {
    @e list {
      width: 300px;
      list-style: none;
      padding: 0;
      margin-bottom: var(--default-margin-small);
      > li {
        float: left;
        position: relative;
        margin: 0 var(--default-margin-small) var(--default-margin-small) 0;
      }
    }
    @e item {
      font-size: 0;
      > img {
        width: 90px;
        height: 90px;
        border-radius: var(--default-radius-mini);
        object-fit: cover;
        border: 1px solid #e8e8e8;
      }
    }
    @e mask {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      background-color: rgba(0, 0, 0, 0.5);
      transition: opacity 0.3s;
      font-size: 16px;
      color: #fff;
      text-align: center;
      line-height: 90px;
      border-radius: var(--default-radius-mini);
      &:hover {
        opacity: 1;
      }
      svg {
        cursor: pointer;
      }
      svg + svg {
        margin-left: var(--default-margin-small);
      }
    }
  }
  @b uploader {
    >>> .el-upload--picture-card {
      width: 80px;
      height: 80px;
      border: none;
      background-color: transparent;
      color: #8c8c8c;
      line-height: 80px;
      border-radius: var(--default-radius-mini);
      &:hover {
        /* border-color: var(--theme-color-primary); */
        /* color: var(--theme-color-primary); */
      }
    }
  }
  @b select-uploader {
    z-index: 100;
    display: inline-block;
    >>> .el-upload--picture-card {
      width: 90px;
      height: 90px;
      /* border: dashed 1px #dcdfe6; */
      background-color: transparent;
      font-size: 18px;
      color: #8c8c8c;
      line-height: 88px;
      border-radius: var(--default-radius-mini);
      display: flex;
      align-items: center;
      justify-content: center;
      &:hover {
        border-color: var(--theme-color-primary);
        color: var(--theme-color-primary);
      }
    }
  }
  @b popover {
    display: flex;
    flex-direction: row;
    align-items: center;
    >>> .popover-base {
      width: 80px;
      height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    >>> .popver-image {
      width: 35px;
      height: 30px;
      color: red;
    }
    >>> .popver-text {
      font-size: 12px;
      color: #303133;
      line-height: 20px;
      font-weight: 400;
      margin-top: 5px;
    }
    >>> .popover-icon {
      font-size: 35px;
      color: #383838;
    }
  }
  @b catalogue {
    @e text {
      vertical-align: middle;
      & + button {
        margin-left: var(--default-margin-larger);
      }
    }
  }
  >>> .el-form-grid {
    margin-left: var(--default-margin-larger);
  }
  @b guide {
    background: #ffffff;
    border: 1px dashed #d9d9d9;
    border-radius: ;
    display: block;
    /* height: 112px; */
    width: 100%;
    margin: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-bottom: 16px;
    >>> .el-upload-dragger {
      width: 100%;
      height: 112px;
      border: none;
      background-color: transparent;
      &:hover {
        /* border-color: var(--theme-color-primary); */
        /* color: var(--theme-color-primary); */
      }
    }
    >>> .el-upload-remind {
      font-size: 14px;
      color: #8c8c8c;
      text-align: center;
      line-height: 22px;
      font-weight: 400;
    }
    >>> .uploading-icon {
      margin-top: 20px;
      width: 60px;
      height: 46px;
      color: #0094fc;
    }
  }
  @b guide-remind {
    >>> .el-textarea__inner {
      height: 112px;
      font-size: 14px;
      line-height: 22px;
      font-weight: 400;
    }
  }
}
</style>
